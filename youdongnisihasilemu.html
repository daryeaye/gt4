<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lost Treasure Pt4 Chef Mario</title>

  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap" rel="stylesheet" />

  <!-- html2canvas (translation widget screenshot) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- PDF.js (Best fix for Google Sites: render PDF in-page, no iframe) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start; /* allow scroll, prevent cut-off */
      background: url('https://daryeaye.github.io/geotopia/thatsit.png') no-repeat center center fixed;
      background-size: cover;
    }

    #app-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      padding-bottom: 40px;
    }

    /* Sticky header so progress bar is always visible */
    #header {
      width: 960px;
      background: #eee;
      padding: 10px;
      margin-bottom: 10px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    #header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    #progressBar {
      width: 100%;
      background: #ccc;
      height: 20px;
      margin-top: 10px;
      position: relative;
    }
    #progress {
      width: 0%;
      background: green;
      height: 100%;
    }

    /* Main stage row: nav buttons on the left, canvas centered */
    #stage-row {
      width: 960px;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Nav buttons: left, vertically stacked, close to canvas */
    #nav-buttons {
      position: absolute;
      left: -150px;          /* close to canvas but outside */
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 0;
    }

    /* keep same position, make them bigger */
    #nav-buttons button {
      font-family: "Caveat", cursive;
      font-size: 26px;
      background-color: lightblue;
      border: none;
      padding: 14px 26px;
      cursor: pointer;
      border-radius: 6px;
      white-space: nowrap;
    }

    #container {
      position: relative;
      width: 960px;
      height: 540px;
      border: 1px solid #ccc;
      background: white;
      overflow: hidden;
    }

    .page {
      position: absolute;
      top: 0;
      left: 0;
      width: 960px;
      height: 540px;
      display: none;
    }
    .page.active { display: block; }

    .box { position: absolute; }

    input.typeable {
      position: absolute;
      font-family: "Comic Sans MS", sans-serif;
      font-size: 22px;
      border: 1px solid black;
      background: rgba(173,216,230,0.5);
      box-sizing: border-box;
      text-align: center;
    }
    .page3-input { font-size: 18px; }

    #page13 .draggable {
      position: relative;
      font-family: "Caveat", cursive;
      font-size: 60px;
    }

    button {
      font-family: "Caveat", cursive;
      font-size: 20px;
      background-color: lightblue;
      border: none;
      padding: 10px 20px;
      margin: 0 5px;
      cursor: pointer;
    }

    /* Page background images */
    #page1  { background:url("https://daryeaye.github.io/gt4/4-01.jpg") no-repeat center center; background-size:cover }
    #page2  { background:url("https://daryeaye.github.io/gt4/4-02.jpg") no-repeat center center; background-size:cover }
    #page3  { background:url("https://daryeaye.github.io/gt4/4-03.jpg") no-repeat center center; background-size:cover }
    #page4  { background:url("https://daryeaye.github.io/gt4/4-04.jpg") no-repeat center center; background-size:cover }
    #page5  { background:url("https://daryeaye.github.io/gt4/4-05.jpg") no-repeat center center; background-size:cover }
    #page6  { background:url("https://daryeaye.github.io/gt4/4-06.jpg") no-repeat center center; background-size:cover }
    #page7  { background:url("https://daryeaye.github.io/gt4/4-07.jpg") no-repeat center center; background-size:cover }
    #page8  { background:url("https://daryeaye.github.io/gt4/4-08.jpg") no-repeat center center; background-size:cover }
    #page9  { background:url("https://daryeaye.github.io/gt4/4-09.jpg") no-repeat center center; background-size:cover }
    #page10 { background:url("https://daryeaye.github.io/gt4/4-10.jpg") no-repeat center center; background-size:cover }
    #page11 { background:url("https://daryeaye.github.io/gt4/4-11.jpg") no-repeat center center; background-size:cover }
    #page12 { background:url("https://daryeaye.github.io/gt4/4-12.jpg") no-repeat center center; background-size:cover }
    #page13 { background:url("https://daryeaye.github.io/gt4/4-13.jpg") no-repeat center center; background-size:cover }
    #page14 { background:url("https://daryeaye.github.io/gt4/4-14.jpg") no-repeat center center; background-size:cover }
    #page15 { background:url("https://daryeaye.github.io/gt4/4-15.jpg") no-repeat center center; background-size:cover }
    #page16 { background:url("https://daryeaye.github.io/gt4/4-16.jpg") no-repeat center center; background-size:cover }
    #page17 { background:url("https://daryeaye.github.io/gt4/4-17.jpg") no-repeat center center; background-size:cover }
    #page18 { background:url("https://daryeaye.github.io/gt4/4-18.jpg") no-repeat center center; background-size:cover }
    #page19 { background:url("https://daryeaye.github.io/gt4/4-19.jpg") no-repeat center center; background-size:cover }
    #page20 { background:url("https://daryeaye.github.io/gt4/4-20.jpg") no-repeat center center; background-size:cover }
    #page21 { background:url("https://daryeaye.github.io/gt4/4-21.jpg") no-repeat center center; background-size:cover }
    #page22 { background:url("https://daryeaye.github.io/gt4/4-22.jpg") no-repeat center center; background-size:cover }
    #page23 { background:url("https://daryeaye.github.io/gt4/4-23.jpg") no-repeat center center; background-size:cover }
    #page24 { background:url("https://daryeaye.github.io/gt4/4-24.jpg") no-repeat center center; background-size:cover }

    /* SECOND CANVAS (Role + PDF viewer) â€” same size as main canvas */
    #role-container {
      width: 960px;
      height: 540px;
      border: 1px solid #ccc;
      margin-top: 16px;
      position: relative;
      overflow: hidden;
      background: #fff;
    }

    /* stage is 960x540; role.jpg is fit without cropping so hotspots align */
    #role-stage {
      width: 960px;
      height: 540px;
      position: absolute;
      inset: 0;
      background: url('https://daryeaye.github.io/geotopia/role.jpg') no-repeat center/contain;
      background-color: #ffffff;
    }

    .role-hotspot {
      position: absolute;
      border: none;
      background: rgba(255,0,0,0); /* invisible */
      cursor: pointer;
      padding: 0;
    }

    /* PDF view */
    #pdf-view {
      position: absolute;
      inset: 0;
      display: none;
      background: #fff;
    }
    #pdf-scroll {
      position: absolute;
      inset: 0;
      overflow: auto;
      padding: 10px;
      box-sizing: border-box;
    }
    #pdf-scroll canvas {
      display: block;
      margin: 0 auto 12px auto;
      border: 1px solid #ddd;
    }

    /* Side translation widget */
    #side-widget{
      position:fixed;
      top:20px;
      right:20px;
      width:200px;
      height:200px;
      background:#f9f9f9;
      border:1px solid #ccc;
      padding:10px;
      box-sizing:border-box;
      font-family:'Caveat',cursive;
      z-index:999;
    }
    #side-widget p.title{font-size:24px;text-align:center;margin:0 0 10px}
    #side-widget button,#side-widget a{
      display:block;
      margin:0 auto;
      font-size:20px;
      cursor:pointer;
      text-align:center;
      background:lightblue;
      border:none;
      padding:10px;
      text-decoration:none;
      color:inherit
    }
    #selection-overlay{position:fixed;top:0;left:0;width:100%;height:100%;cursor:crosshair;z-index:1000}
    #selection-box{position:absolute;border:2px dashed red;background:rgba(0,0,0,0.1)}
  </style>
</head>

<body>
  <div id="app-container">
    <div id="header">
      <div id="header-top">
        <div>
          <input type="text" id="username" placeholder="Enter your name" style="font-size:16px; padding:5px;" />
          <button id="confirmBtn" onclick="confirmName()">Confirm</button>
        </div>
      </div>
      <div id="progressBar"><div id="progress"></div></div>
      <span id="progressText">0% completed</span>
    </div>

    <div id="stage-row">
      <div id="nav-buttons">
        <button id="prev-btn" onclick="prevPage()">Previous</button>
        <button id="next-btn" onclick="nextPage()">Next</button>
      </div>

      <div id="container">
        <!-- PAGE 1: role boxes removed + role-for button removed -->
        <div id="page1" class="page active"></div>

        <div id="page2" class="page"></div>

        <div id="page3" class="page">
          <input type="text" id="page3_input1" class="typeable page3-input" style="left:22px; top:191px; width:112px; height:30px;">
          <input type="text" id="page3_input2" class="typeable page3-input" style="left:22px; top:287px; width:139px; height:30px;">
          <input type="text" id="page3_input3" class="typeable page3-input" style="left:219px; top:325px; width:153px; height:30px;">
          <input type="text" id="page3_input4" class="typeable page3-input" style="left:207px; top:384px; width:139px; height:30px;">
          <input type="text" id="page3_input5" class="typeable page3-input" style="left:270px; top:421px; width:139px; height:30px;">
        </div>

        <div id="page4" class="page">
          <canvas id="canvas4" width="960" height="540" style="border:1px solid #ccc;"></canvas>
          <button id="reset4" style="position:absolute;bottom:10px;right:10px;">Reset</button>
        </div>

        <div id="page5" class="page">
          <canvas id="canvas5" width="960" height="540" style="border:1px solid #ccc;"></canvas>
          <button id="reset5" style="position:absolute;bottom:10px;right:10px;">Reset</button>
        </div>

        <div id="page6" class="page">
          <div style="transform:scale(0.7);transform-origin:top center;width:100%;display:flex;justify-content:center;padding-top:10px;">
            <iframe src="https://www.geogebra.org/material/iframe/id/nwjp94mb/width/1200/height/600/border/888888/rc/false/ai/false" width="1200" height="500" style="border:0;"></iframe>
          </div>
          <input type="text" id="page6_input1" class="typeable" style="left:285px; top:399px; width:100px; height:44px;">
          <input type="text" id="page6_input2" class="typeable" style="left:285px; top:474px; width:100px; height:43px;">
        </div>

        <div id="page7" class="page">
          <input type="text" id="page7_input1" class="typeable" style="left:537px; top:226px; width:374px; height:43px;">
          <input type="text" id="page7_input2" class="typeable" style="left:268px; top:226px; width:117px; height:43px;">
          <input type="text" id="page7_input3" class="typeable" style="left:537px; top:273px; width:374px; height:43px;">
          <input type="text" id="page7_input4" class="typeable" style="left:268px; top:273px; width:117px; height:43px;">
          <input type="text" id="page7_input5" class="typeable" style="left:537px; top:320px; width:374px; height:43px;">
          <input type="text" id="page7_input6" class="typeable" style="left:170px; top:320px; width:117px; height:43px;">
          <input type="text" id="page7_input7" class="typeable" style="left:671px; top:404px; width:166px; height:52px;">
        </div>

        <div id="page8" class="page">
          <input type="text" id="page8_input1" class="typeable" style="left:707px; top:124px; width:68px; height:46px;">
          <input type="text" id="page8_input2" class="typeable" style="left:49px; top:168px; width:104px; height:46px;">
          <input type="text" id="page8_input3" class="typeable" style="left:492px; top:207px; width:102px; height:44px;">
        </div>

        <div id="page9" class="page">
          <div style="transform:scale(0.7);transform-origin:top center;width:100%;display:flex;justify-content:center;padding-top:10px;">
            <iframe src="https://daryeaye.github.io/gt4/circle.html" width="1200" height="600" style="border:0;"></iframe>
          </div>
          <div id="page9_modal" style="display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border:2px solid black;padding:20px;z-index:1000;">
            <p>Chef Mario needs to make sure youâ€™ve watched the whole process from start to finish.</p>
            <button onclick="finishPage9()">Finished</button>
            <button onclick="cancelPage9()">Not yet</button>
          </div>
        </div>

        <div id="page10" class="page">
          <div style="transform:scale(0.7);transform-origin:top center;width:100%;display:flex;justify-content:center;padding-top:10px;">
            <iframe src="https://www.geogebra.org/material/iframe/id/wrnwxz65/width/1200/height/700/border/888888/rc/false/ai/false" width="1200" height="570" style="border:0;"></iframe>
          </div>
          <input type="text" id="page10_input1" class="typeable" style="left:780px; top:414px; width:100px; height:43px;">
          <input type="text" id="page10_input2" class="typeable" style="left:765px; top:459px; width:100px; height:43px;">
        </div>

        <div id="page11" class="page">
          <input type="text" id="page11_input1" class="typeable" style="left:631px; top:215px; width:292px; height:43px;">
          <input type="text" id="page11_input2" class="typeable" style="left:374px; top:216px; width:171px; height:43px;">
          <input type="text" id="page11_input3" class="typeable" style="left:147px; top:216px; width:117px; height:43px;">
          <input type="text" id="page11_input4" class="typeable" style="left:631px; top:266px; width:292px; height:43px;">
          <input type="text" id="page11_input5" class="typeable" style="left:374px; top:266px; width:171px; height:43px;">
          <input type="text" id="page11_input6" class="typeable" style="left:147px; top:266px; width:117px; height:43px;">
          <input type="text" id="page11_input7" class="typeable" style="left:321px; top:315px; width:104px; height:43px;">
          <input type="text" id="page11_input8" class="typeable" style="left:147px; top:315px; width:117px; height:43px;">
          <input type="text" id="page11_input9" class="typeable" style="left:631px; top:316px; width:292px; height:43px;">
          <input type="text" id="page11_input10" class="typeable" style="left:442px; top:425px; width:142px; height:52px;">
        </div>

        <div id="page12" class="page">
          <input type="text" id="page12_input1" class="typeable" style="left:258px; top:139px; width:119px; height:45px;">
          <input type="text" id="page12_input2" class="typeable" style="left:787px; top:139px; width:86px; height:44px;">
          <input type="text" id="page12_input3" class="typeable" style="left:769px; top:188px; width:114px; height:45px;">
        </div>

        <div id="page13" class="page">
          <div id="page13_box1" class="draggable" style="left:836px; top:146px; width:61px; height:75px;position:absolute;border:1px solid black;text-align:center;line-height:75px;">r</div>
          <div id="page13_box2" class="draggable" style="left:750px; top:150px; width:61px; height:67px;position:absolute;border:1px solid black;text-align:center;line-height:67px;">Ï€</div>
          <div id="page13_box3" class="draggable" style="left:790px; top:237px; width:61px; height:74px;position:absolute;border:1px solid black;text-align:center;line-height:74px;">Ï€</div>
          <div id="page13_box4" class="draggable" style="left:874px; top:237px; width:60px; height:74px;position:absolute;border:1px solid black;text-align:center;line-height:74px;">2</div>
          <div id="page13_box5" class="draggable" style="left:707px; top:239px; width:61px; height:75px;position:absolute;border:1px solid black;text-align:center;line-height:75px;">Ï€</div>
          <div id="page13_box6" class="draggable" style="left:734px; top:327px; width:61px; height:75px;position:absolute;border:1px solid black;text-align:center;line-height:75px;">d</div>
          <div id="page13_box7" class="draggable" style="left:840px; top:327px; width:75px; height:74px;position:absolute;border:1px solid black;text-align:center;line-height:74px;">rÂ²</div>
        </div>

        <div id="page14" class="page"></div>

        <div id="page15" class="page">
          <input type="text" id="page15_input1" class="typeable" style="left:427px; top:226px; width:420px; height:205px; font-size:20px;">
        </div>

        <div id="page16" class="page">
          <input type="text" id="page16_input1" class="typeable" style="left:570px; top:91px; width:82px; height:45px;">
          <input type="text" id="page16_input2" class="typeable" style="left:484px; top:254px; width:327px; height:80px;">
          <input type="text" id="page16_input3" class="typeable" style="left:484px; top:389px; width:327px; height:80px;">
        </div>

        <div id="page17" class="page">
          <input type="text" id="page17_input1" class="typeable" style="left:596px; top:150px; width:82px; height:45px;">
          <input type="text" id="page17_input2" class="typeable" style="left:484px; top:254px; width:327px; height:80px;">
          <input type="text" id="page17_input3" class="typeable" style="left:484px; top:389px; width:327px; height:80px;">
        </div>

        <div id="page18" class="page">
          <input type="text" id="page18_input1" class="typeable" style="left:579px; top:89px; width:82px; height:45px;">
          <input type="text" id="page18_input2" class="typeable" style="left:484px; top:254px; width:327px; height:80px;">
          <input type="text" id="page18_input3" class="typeable" style="left:484px; top:389px; width:327px; height:80px;">
        </div>

        <div id="page19" class="page">
          <input type="text" id="page19_input1" class="typeable" style="left:596px; top:150px; width:82px; height:45px;">
          <input type="text" id="page19_input2" class="typeable" style="left:484px; top:254px; width:327px; height:80px;">
          <input type="text" id="page19_input3" class="typeable" style="left:484px; top:389px; width:327px; height:80px;">
        </div>

        <div id="page20" class="page">
          <input type="text" id="page20_input1" class="typeable" style="left:573px; top:90px; width:82px; height:45px;">
          <input type="text" id="page20_input2" class="typeable" style="left:596px; top:150px; width:82px; height:45px;">
          <input type="text" id="page20_input3" class="typeable" style="left:484px; top:389px; width:327px; height:80px;">
        </div>

        <div id="page21" class="page">
          <input type="text" id="page21_input1" class="typeable" style="left:573px; top:90px; width:82px; height:45px;">
          <input type="text" id="page21_input2" class="typeable" style="left:596px; top:150px; width:82px; height:45px;">
          <input type="text" id="page21_input3" class="typeable" style="left:484px; top:389px; width:327px; height:80px;">
        </div>

        <div id="page22" class="page"></div>

        <div id="page23" class="page">
          <input type="text" id="page23_input1" class="typeable" style="left:391px; top:373px; width:178px; height:44px;">
          <button id="unlockButton" style="position:absolute;left:391px;top:415px;width:100px;height:30px;" onclick="unlockPage23()">Unlock</button>
        </div>

        <div id="page24" class="page">
          <a href="https://daryeaye.github.io/gt4/alun.html" target="_blank"
             style="display:block;position:absolute;left:310px;top:435px;width:370px;height:45px;background:rgba(0,0,255,0.5);text-decoration:none;"></a>
        </div>
      </div>
    </div>

    <!-- SECOND CANVAS: Role selection + PDF.js viewer -->
    <div id="role-container">
      <div id="role-stage">
        <!-- Hotspots scaled from 1600x900 -> 960x540 (x0.6) -->
        <button class="role-hotspot" id="hotspot-officer"  title="Officer"
          style="left:117px; top:73px; width:197px; height:166px;"></button>

        <button class="role-hotspot" id="hotspot-professor" title="Professor"
          style="left:382px; top:73px; width:197px; height:166px;"></button>

        <button class="role-hotspot" id="hotspot-hacker"   title="Hacker"
          style="left:647px; top:73px; width:197px; height:166px;"></button>

        <!-- Video hotspot opens a new tab -->
        <button class="role-hotspot" id="hotspot-video" title="What is the role for?"
          style="left:301px; top:460px; width:358px; height:31px;"></button>
      </div>

      <div id="pdf-view">
        <div id="pdf-scroll"></div>
      </div>
    </div>

    <!-- Translation widget -->
    <div id="side-widget">
      <p class="title">Need translation?</p>
      <button id="select-text">Select Text</button>
      <p><a href="https://translate.google.com/?sl=en&tl=es&op=images" target="_blank">Click me and paste from clipboard</a></p>
    </div>
  </div>

  <script>
    // PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    // Role PDFs
    const ROLE_PDFS = {
      officer:   "https://daryeaye.github.io/geotopia/GT1%20Officer+.pdf",
      professor: "https://daryeaye.github.io/geotopia/GT1%20Professor+.pdf",
      hacker:    "https://daryeaye.github.io/geotopia/GT1%20Hacker+.pdf"
    };

    const roleStage = document.getElementById("role-stage");
    const pdfView   = document.getElementById("pdf-view");
    const pdfScroll = document.getElementById("pdf-scroll");

    async function loadPdfInSecondCanvas(url){
      // switch to PDF mode
      roleStage.style.display = "none";
      pdfView.style.display = "block";
      pdfScroll.innerHTML = "";

      try{
        const loadingTask = pdfjsLib.getDocument({ url });
        const pdf = await loadingTask.promise;

        // Render each page scaled to fit width (approx 940px inside padding)
        const targetWidth = 940;

        for(let pageNum=1; pageNum<=pdf.numPages; pageNum++){
          const page = await pdf.getPage(pageNum);

          const viewport1 = page.getViewport({ scale: 1 });
          const scale = targetWidth / viewport1.width;
          const viewport = page.getViewport({ scale });

          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = Math.floor(viewport.width);
          canvas.height = Math.floor(viewport.height);

          pdfScroll.appendChild(canvas);

          await page.render({ canvasContext: ctx, viewport }).promise;
        }
      }catch(err){
        console.error(err);
        alert("PDF failed to load in the canvas. Check Console for details.");
        // fallback back to role stage
        pdfView.style.display = "none";
        roleStage.style.display = "block";
      }
    }

    // Role hotspots
    document.getElementById("hotspot-officer").addEventListener("click", () => loadPdfInSecondCanvas(ROLE_PDFS.officer));
    document.getElementById("hotspot-professor").addEventListener("click", () => loadPdfInSecondCanvas(ROLE_PDFS.professor));
    document.getElementById("hotspot-hacker").addEventListener("click", () => loadPdfInSecondCanvas(ROLE_PDFS.hacker));

    // Video hotspot opens new tab
    document.getElementById("hotspot-video").addEventListener("click", () => {
      window.open("https://www.youtube.com/watch?v=Fj98o3aFfk8", "_blank");
    });

    // ----------------- Your original logic (kept) -----------------
    let currentPage = 1, totalPages = 24, maxPageVisited = 1;

    function updateProgress(){
      const p = (maxPageVisited / totalPages) * 100;
      document.getElementById("progress").style.width = p + "%";
      document.getElementById("progressText").innerText = p.toFixed(0) + "% completed";
    }

    function validateCurrentPage(){
      if(currentPage===3){
        let cnt=0;
        for(let i=1;i<=5;i++){
          const inp=document.getElementById("page3_input"+i);
          if(inp && inp.value.trim()!=="") cnt++;
        }
        if(cnt<3){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
      }
      if(currentPage===7){
        const i6=document.getElementById("page7_input6"), i7=document.getElementById("page7_input7");
        if(i6 && !i6.value.includes("25")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
        if(i7 && !i7.value.includes("3.14")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
      }
      if(currentPage===8){
        const i2=document.getElementById("page8_input2"), i3=document.getElementById("page8_input3");
        if(i2 && !i2.value.includes("21")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
        if(i3 && !i3.value.includes("15")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
      }
      if(currentPage===10){
        const i1=document.getElementById("page10_input1"), i2=document.getElementById("page10_input2");
        if(i1 && !i1.value.includes("81")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
        if(i2 && !i2.value.includes("50")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
      }
      if(currentPage===11){
        const i7=document.getElementById("page11_input7"),
              i8=document.getElementById("page11_input8"),
              i10=document.getElementById("page11_input10");
        if(i7 && !i7.value.includes("254")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
        if(i8 && !i8.value.includes("81")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
        if(i10 && !i10.value.includes("3.14")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
      }
      if(currentPage===12){
        const i1=document.getElementById("page12_input1"), i3=document.getElementById("page12_input3");
        if(i1 && !i1.value.includes("18")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
        if(i3 && !i3.value.includes("38")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
      }
      if(currentPage===15){
        const inp=document.getElementById("page15_input1");
        if(inp && !inp.value.includes("314")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
      }
      if(currentPage===16){
        const i2=document.getElementById("page16_input2"), i3=document.getElementById("page16_input3");
        if(i2 && !i2.value.includes("23")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
        if(i3 && !i3.value.includes("45")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
      }
      if(currentPage===17){
        const i2=document.getElementById("page17_input2"), i3=document.getElementById("page17_input3");
        if(i2 && !i2.value.includes("28")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
        if(i3 && !i3.value.includes("63")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
      }
      if(currentPage===18){
        const i2=document.getElementById("page18_input2"), i3=document.getElementById("page18_input3");
        if(i2 && !i2.value.includes("12")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
        if(i3 && !i3.value.includes("12")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
      }
      if(currentPage===19){
        const i2=document.getElementById("page19_input2"), i3=document.getElementById("page19_input3");
        if(i2 && !i2.value.includes("18")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
        if(i3 && !i3.value.includes("28")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
      }
      if(currentPage===20){
        const i3=document.getElementById("page20_input3");
        if(i3 && !i3.value.includes("7")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
      }
      if(currentPage===21){
        const i3=document.getElementById("page21_input3");
        if(i3 && !i3.value.includes("490")){ alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct."); return false; }
      }
      return true;
    }

    function unlockPage23(){
      const inp=document.getElementById("page23_input1");
      if(!inp) return;
      if(inp.value==="78.5ma"){
        window.open("https://daryeaye.github.io/geotopia/adebayue.pdf","_blank");
        inp.value="";
        nextPage();
      }else if(inp.value==="78.5"){
        alert("âœ…Yes! Ask the merchant to open it!");
      }else{
        alert("ðŸ™Chef Mario is unhappy. Letâ€™s make it correct.");
      }
    }

    function showPage(p){
      for(let i=1;i<=totalPages;i++){
        const pg=document.getElementById("page"+i);
        if(pg) pg.classList.remove("active");
      }
      const np=document.getElementById("page"+p);
      if(np) np.classList.add("active");

      document.getElementById("prev-btn").style.display = p===1 ? "none" : "inline-block";
      document.getElementById("next-btn").style.display = p===totalPages ? "none" : "inline-block";

      updateProgress();
    }

    function nextPage(){
      if(currentPage===9){
        document.getElementById("page9_modal").style.display="block";
        return;
      }
      if(!validateCurrentPage()) return;

      if(currentPage < totalPages){
        currentPage++;
        if(currentPage > maxPageVisited) maxPageVisited = currentPage;
        showPage(currentPage);
      }
    }

    function prevPage(){
      if(currentPage>1){
        currentPage--;
        showPage(currentPage);
      }
    }

    function confirmName(){
      const ni=document.getElementById("username"), name=ni.value.trim();
      if(name!==""){
        localStorage.setItem("username",name);
        ni.disabled=true;
        alert("Name confirmed as: "+name);
      }else{
        alert("Please enter a name.");
      }
    }

    function setupPersistence(){
      const n=localStorage.getItem("username"), ni=document.getElementById("username");
      if(n!==null && n!==""){ ni.value=n; ni.disabled=true; }

      document.querySelectorAll("input[type='text']").forEach(el=>{
        const key=el.id, st=localStorage.getItem(key);
        if(st!==null){ el.value=st; }
        el.addEventListener("input",()=>{ localStorage.setItem(key, el.value); });
      });
    }

    function setupDrawing(canvasId, resetButtonId, storageKey){
      const canvas=document.getElementById(canvasId), ctx=canvas.getContext("2d");
      let drawing=false, startX=0, startY=0, lines=[];
      const stored=localStorage.getItem(storageKey);
      if(stored){
        try{ lines=JSON.parse(stored); redraw(); }catch(e){ lines=[]; }
      }

      function redraw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        lines.forEach(l=>{
          ctx.beginPath();
          ctx.moveTo(l.startX,l.startY);
          ctx.lineTo(l.endX,l.endY);
          ctx.strokeStyle="red";
          ctx.lineWidth=2;
          ctx.stroke();
        });
      }

      canvas.addEventListener("mousedown",function(e){
        if(lines.length>=3) return;
        drawing=true;
        const r=canvas.getBoundingClientRect();
        startX=e.clientX-r.left;
        startY=e.clientY-r.top;
      });

      canvas.addEventListener("mousemove",function(e){
        if(!drawing) return;
        const r=canvas.getBoundingClientRect(), curX=e.clientX-r.left, curY=e.clientY-r.top;
        redraw();
        ctx.beginPath();
        ctx.moveTo(startX,startY);
        ctx.lineTo(curX,curY);
        ctx.strokeStyle="red";
        ctx.lineWidth=2;
        ctx.stroke();
      });

      canvas.addEventListener("mouseup",function(e){
        if(!drawing) return;
        drawing=false;
        const r=canvas.getBoundingClientRect(), endX=e.clientX-r.left, endY=e.clientY-r.top;
        lines.push({startX,startY,endX,endY});
        localStorage.setItem(storageKey, JSON.stringify(lines));
        redraw();
      });

      canvas.addEventListener("mouseleave",function(e){
        if(drawing){
          drawing=false;
          const r=canvas.getBoundingClientRect(), endX=e.clientX-r.left, endY=e.clientY-r.top;
          lines.push({startX,startY,endX,endY});
          localStorage.setItem(storageKey, JSON.stringify(lines));
          redraw();
        }
      });

      document.getElementById(resetButtonId).addEventListener("click",function(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        lines=[];
        localStorage.removeItem(storageKey);
      });
    }

    function setupDraggable(id){
      const b=document.getElementById(id);
      let offX, offY;

      b.addEventListener("mousedown",function(e){
        offX=e.clientX-b.offsetLeft;
        offY=e.clientY-b.offsetTop;

        function mH(e){
          b.style.left=(e.clientX-offX)+"px";
          b.style.top=(e.clientY-offY)+"px";
        }
        function uH(){
          document.removeEventListener("mousemove",mH);
          document.removeEventListener("mouseup",uH);
          localStorage.setItem(id, JSON.stringify({left:b.style.left, top:b.style.top}));
        }

        document.addEventListener("mousemove",mH);
        document.addEventListener("mouseup",uH);
      });

      const s=localStorage.getItem(id);
      if(s){
        const pos=JSON.parse(s);
        b.style.left=pos.left;
        b.style.top=pos.top;
      }
    }

    function finishPage9(){
      document.getElementById("page9_modal").style.display="none";
      if(!validateCurrentPage()) return;
      currentPage++;
      if(currentPage>maxPageVisited) maxPageVisited=currentPage;
      showPage(currentPage);
    }
    function cancelPage9(){
      document.getElementById("page9_modal").style.display="none";
    }

    document.addEventListener("DOMContentLoaded",function(){
      showPage(currentPage);
      setupPersistence();
      setupDrawing("canvas4","reset4","canvas4_lines");
      setupDrawing("canvas5","reset5","canvas5_lines");
      for(let i=1;i<=7;i++){ setupDraggable("page13_box"+i); }
    });

    // Translation widget screenshot selection
    document.getElementById("select-text").addEventListener("click",function(){
      const o=document.createElement("div");
      o.id="selection-overlay";
      document.body.appendChild(o);

      let sX,sY,sB;
      o.addEventListener("mousedown",function(e){
        sX=e.clientX; sY=e.clientY;
        sB=document.createElement("div");
        sB.id="selection-box";
        sB.style.left=sX+"px";
        sB.style.top=sY+"px";
        sB.style.width="0px";
        sB.style.height="0px";
        o.appendChild(sB);

        function mH(e){
          const cX=e.clientX,cY=e.clientY,
                l=Math.min(sX,cX),t=Math.min(sY,cY),
                w=Math.abs(cX-sX),h=Math.abs(cY-sY);
          sB.style.left=l+"px";
          sB.style.top=t+"px";
          sB.style.width=w+"px";
          sB.style.height=h+"px";
        }

        function uH(e){
          o.removeEventListener("mousemove",mH);
          o.removeEventListener("mouseup",uH);

          const r=sB.getBoundingClientRect();
          document.body.removeChild(o);

          const T=document.getElementById("container"),TR=T.getBoundingClientRect();
          html2canvas(T,{useCORS:true,allowTaint:false}).then(canvas=>{
            const sf=canvas.width/TR.width,
                  sx=(r.left-TR.left)*sf,
                  sy=(r.top-TR.top)*sf,
                  sw=r.width*sf,
                  sh=r.height*sf,
                  cc=document.createElement("canvas");
            cc.width=sw; cc.height=sh;
            const ctx=cc.getContext("2d");
            ctx.drawImage(canvas,sx,sy,sw,sh,0,0,sw,sh);
            cc.toBlob(blob=>{
              if(blob){
                const itm=new ClipboardItem({"image/png":blob});
                navigator.clipboard.write([itm]).then(()=>{
                  alert("Screenshot copied to clipboard.");
                }).catch(err=>{
                  console.error("Failed to copy screenshot to clipboard",err);
                  alert("Failed to copy screenshot to clipboard.");
                });
              }
            });
          });
        }

        o.addEventListener("mousemove",mH);
        o.addEventListener("mouseup",uH);
      });
    });
  </script>

  <!-- Â©XDY. All rights reserved. This code is the intellectual property of XDY.
       Unauthorized copying, reproduction, or redistribution is strictly prohibited.
       For educational use only. Contact the author for permissions. -->
</body>
</html>
